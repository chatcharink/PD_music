<% is_user_logged_in? %>

<div class="h-100" data-controller="food">
    <div class="border-bottom">
        <h5 class="title-menu ms-3 my-3 d-inline-block">Order</h5>

        <% if can_view_menu?([42]) || can_view_menu?([37]) %>
        <div class="dropdown float-end mt-1 p-2 me-3 rounded-3 dropdown-more-setting-order">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-three-dots-vertical" viewBox="0 0 16 16" id="dropdownOrderSetting" data-bs-toggle="dropdown" aria-expanded="false">
                <path d="M9.5 13a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0m0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0m0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0"/>
            </svg>
            <ul class="dropdown-menu" aria-labelledby="dropdownOrderSetting">
                <% if can_view_menu?([42]) %>
                <li><button type="button" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#settingOrder">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-gear" viewBox="0 0 16 16">
                            <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492M5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0"/>
                            <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.291-.16c.764-.415 1.6.42 1.184 1.185l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.291c.415.764-.42 1.6-1.185 1.184l-.291-.159a1.873 1.873 0 0 0-2.693 1.116l-.094.318c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.692-1.115l-.292.16c-.764.415-1.6-.42-1.184-1.185l.159-.291A1.873 1.873 0 0 0 1.945 8.93l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094A1.873 1.873 0 0 0 3.06 4.377l-.16-.292c-.415-.764.42-1.6 1.185-1.184l.292.159a1.873 1.873 0 0 0 2.692-1.115z"/>
                        </svg> Setting
                    </button>
                </li>
                <% end %>
                <% if can_view_menu?([37]) %>
                <li><button type="button" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#exportOrder">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-up-right" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M8.636 3.5a.5.5 0 0 0-.5-.5H1.5A1.5 1.5 0 0 0 0 4.5v10A1.5 1.5 0 0 0 1.5 16h10a1.5 1.5 0 0 0 1.5-1.5V7.864a.5.5 0 0 0-1 0V14.5a.5.5 0 0 1-.5.5h-10a.5.5 0 0 1-.5-.5v-10a.5.5 0 0 1 .5-.5h6.636a.5.5 0 0 0 .5-.5"/>
                            <path fill-rule="evenodd" d="M16 .5a.5.5 0 0 0-.5-.5h-5a.5.5 0 0 0 0 1h3.793L6.146 9.146a.5.5 0 1 0 .708.708L15 1.707V5.5a.5.5 0 0 0 1 0z"/>
                        </svg> Export order
                    </button>
                </li>
                <% end %>
            </ul>
        </div>
        <% end %>

        <% if can_view_menu?([29]) %>
            <%= link_to food_order_path(), class: "btn btn-primary float-end me-3 mt-2" do %>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-cart-plus" viewBox="0 0 16 16">
                    <path d="M9 5.5a.5.5 0 0 0-1 0V7H6.5a.5.5 0 0 0 0 1H8v1.5a.5.5 0 0 0 1 0V8h1.5a.5.5 0 0 0 0-1H9z"/>
                    <path d="M.5 1a.5.5 0 0 0 0 1h1.11l.401 1.607 1.498 7.985A.5.5 0 0 0 4 12h1a2 2 0 1 0 0 4 2 2 0 0 0 0-4h7a2 2 0 1 0 0 4 2 2 0 0 0 0-4h1a.5.5 0 0 0 .491-.408l1.5-8A.5.5 0 0 0 14.5 3H2.89l-.405-1.621A.5.5 0 0 0 2 1zm3.915 10L3.102 4h10.796l-1.313 7zM6 14a1 1 0 1 1-2 0 1 1 0 0 1 2 0m7 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0"/>
                </svg> Order
            <% end %>
        <% end %>
    </div>

    <% if session["current_user"]["role"] == 1 %>
        <% date_from = DateTime.now() %>
        <% date_to = DateTime.now() + @order_setting["pre_order"].to_i-1 %>
        <button class="btn btn-filter-date-range mb-3 border-bottom" type="button" data-bs-toggle="collapse" data-bs-target="#filterDateRange" aria-expanded="false" aria-controls="filterDateRange">
            <%= date_from.strftime("%d/%m/%Y") %> ~ <%= date_to.strftime("%d/%m/%Y") %>
        </button>
        <div class="collapse mb-3" id="filterDateRange">
            <div class="row px-3 pb-3 border-bottom" style="align-items: end;">
                <div class="col-4">
                    <label for="filter_date_from" class="form-label">Date From</label>
                    <%= date_field_tag :filter_date_from, date_from.strftime("%Y-%m-%d"), class: "form-control" , id: "filter_date_from" %>
                </div>
                <div class="col-4">
                    <label for="filter_date_to" class="form-label">To</label>
                    <%= date_field_tag :filter_date_to, date_to.strftime("%Y-%m-%d"), class: "form-control" , id: "filter_date_to" %>
                </div>
                <div class="col-1">
                    <button class="btn btn-primary" data-action="click->food#filterDateRange" data-food-url-param="<%= food_filter_date_path() %>">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16">
                            <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <div class="div-summary-all-order-list h-100">
            <%= render partial: "summary_all_ordered", locals: {date_from: date_from, date_to: date_to} %>
        </div>
    <% else %>
        <div class="div-summary-order-list mt-3 h-100">
            <%= render partial: "summary_ordered" %>
        </div>
    <% end %>


    <div class="modal fade" id="settingOrder" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="settingOrderLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="settingOrderLabel">Setting</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="pre-order" class="form-label">How many days to pre-order :</label>
                        <%= select_tag "preorder", options_for_select((1..10).to_a, @order_setting["pre_order"].to_i), class: "form-select", id: "pre-order" %>
                    </div>
                    <div class="mb-3 div-pre-order-range">
                    </div>
                    <div class="mb-3">
                        <label for="times-order" class="form-label">How many times to order per day :</label>
                        <%= select_tag "times_order", options_for_select((1..10).to_a, @order_setting["times_per_day"].to_i), class: "form-select", id: "times-order", "data-action": "change->food#selectTimesPerDay" %>
                    </div>
                    <div class="mb-3 div-meal-name">
                        <div class="mb-3 row">
                            <label for="mealName1" class="col-sm-3 col-form-label text-end">Meal name#1</label>
                            <div class="col-sm-8">
                                <%= text_field_tag "mealName1", "", class: "form-control txt_meal_name", id: "mealName1" %>
                            </div>
                        </div>
                        <div class="mb-3 row">
                            <label for="mealName2" class="col-sm-3 col-form-label text-end">Meal name#2</label>
                            <div class="col-sm-8">
                                <%= text_field_tag "mealName2", "", class: "form-control txt_meal_name", id: "mealName2" %>
                            </div>
                        </div>
                        <div class="mb-3 row">
                            <label for="mealName3" class="col-sm-3 col-form-label text-end">Meal name#3</label>
                            <div class="col-sm-8">
                                <%= text_field_tag "mealName3", "", class: "form-control txt_meal_name", id: "mealName3" %>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-action="click->food#settingOrder" data-food-url-param="<%= food_set_order_rule_path %>">Set</button>
                    <button type="button" class="btn btn-outline-primary" id="close-setting-order-dialog" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="exportOrder" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="exportOrderLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <%= form_for "form_export", url: food_export_order_path(format: :xlsx), "data-turbolinks": false, method: :POST do |f| %>
                <div class="modal-header">
                    <h5 class="modal-title" id="exportOrderLabel">Export order</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="pre-order" class="form-label">Date from :</label>
                        <%= f.date_field :date_from, as: :date, value: DateTime.now().strftime("%Y-%m-%d"), class: "form-control" , id: "date_from" %>
                    </div>
                    <div class="mb-3">
                        <label for="times-order" class="form-label">Date to :</label>
                        <%= f.date_field :date_to, as: :date, value: DateTime.now().strftime("%Y-%m-%d"), class: "form-control" , id: "date_to" %>
                    </div>
                </div>
                <div class="modal-footer">
                    <%= f.submit "Export", class: "btn btn-primary", "data-bs-dismiss": "modal", "data-action": "click->food#exportOrder" %>
                    <button type="button" class="btn btn-outline-primary" data-bs-dismiss="modal">Close</button>
                </div>
                <% end %>
            </div>
        </div>
    </div>

    <%= render partial: "ticket" %>
</div>